name: Unified Approval & Tag Build

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  check_approvals:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    outputs:
      approved: ${{ steps.approval.outputs.approved }}
    steps:
      - name: Require manual approval
        id: approval
        uses: trstringer/manual-approval@v1
        timeout-minutes: 60
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: wthrajat,vaibhav-init
          minimum-approvals: 1
          issue-title: 'Manual build approval'
          issue-body: 'Please approve or deny this build'
          exclude-workflow-initiator-as-approver: true

  dispatch_build:
    runs-on: ubuntu-latest
    outputs:
      run_build: ${{ steps.set.outputs.run_build }}
    needs: [check_approvals]
    if: |
      github.event_name == 'workflow_dispatch' && needs.check_approvals.outputs.approved == 'true'
    steps:
      - id: set
        run: echo "run_build=true" >> "$GITHUB_OUTPUT"

  skip_dispatch_build:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    outputs:
      run_build: true
    steps:
      - run: echo "Skipping manual approval for tag push"

  build:
    needs: [dispatch_build, skip_dispatch_build]
    if: |
      needs.dispatch_build.outputs.run_build == 'true' || needs.skip_dispatch_build.outputs.run_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Real Build Starts Here
        run: echo "ğŸš€ Building now (trigger => ${{ github.event_name }})"
