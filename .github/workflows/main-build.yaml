name: Build job

on:
  workflow_dispatch:
  push:


jobs:
  check_approvals:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    outputs:
      approved: ${{ steps.approval.outputs.approved }}
    steps:
      - name: Require manual approval
        id: approval
        uses: trstringer/manual-approval@v1
        timeout-minutes: 60
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: wthrajat,vaibhav-init
          minimum-approvals: 1
          issue-title: 'Manual build approval'
          issue-body: 'Please approve or deny this build'
          exclude-workflow-initiator-as-approver: true

  build:
    needs: check_approvals
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether to build
        id: decision
        run: |
          echo "event: ${{ github.event_name }}"
          echo "ref: ${{ github.ref }}"
          echo "approved: ${{ needs.check_approvals.outputs.approved }}"
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            echo "Proceeding: tag push"
            echo "proceed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ needs.check_approvals.outputs.approved }}" == "true" ]]; then
            echo "Proceeding: manual approved"
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "Not approved, skipping build"
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run build if allowed
        if: steps.decision.outputs.proceed == 'true'
        run: echo "🚀 Running build!"

      - name: Skip build message
        if: steps.decision.outputs.proceed != 'true'
        run: echo "❌ Build skipped — not approved or unexpected trigger"
